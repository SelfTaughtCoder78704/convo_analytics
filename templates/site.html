<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SITE</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
      }

      .disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .spinnerWrap {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
      }
      .spinner {
        border: 2px solid #f3f3f3; /* Light grey border */
        border-top: 2px solid #3498db; /* Blue border on top */
        border-radius: 50%; /* Rounded border */
        width: 100px; /* Width and height of the spinner */
        height: 100px;
        animation: spin 0.8s linear infinite; /* Animation properties */
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg); /* Start at 0 degrees */
        }
        100% {
          transform: rotate(360deg); /* End at 360 degrees (full circle) */
        }
      }

      .top {
        background: rgb(44, 87, 204);
        color: white;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
      }
      .editForm {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: fit-content;
        font-family: sans-serif;
        float: right;
      }

      form input[type="submit"] {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
      }

      form input[type="text"] {
        width: 300px;
        padding: 12px 20px;
        margin: 8px 0;
        box-sizing: border-box;
        border: 2px solid #ccc;
        border-radius: 4px;
        outline: none;
      }

      .btn {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
      }

      form label {
        display: block;
        margin-bottom: 0.5rem;
      }

      form button:hover {
        background-color: #3e8e41;
      }

      .configureScript {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
      }

      #elements {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border-radius: 5px;
        border: 1px solid gray;
      }
      .configOptions {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: fit-content;
        font-family: sans-serif;
      }

      .thingYouAreTargeting {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
      }

      .targetedElements {
        background: rgb(28, 28, 28);
        color: black;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
        background: white;
        font-weight: bold;
        padding: 20px;
      }

      .script {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
      }

      .generateScript {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: fit-content;
        font-family: sans-serif;
      }

      .scriptCode {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
        background: white;
        padding: 20px;
        display: flex;
        flex-direction: row;
        gap: 20px;
      }

      .clickToCopy {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: fit-content;
        font-family: sans-serif;
      }

      .events {
        background: rgb(28, 28, 28);
        color: white;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
      }

      .eventList {
        background: rgb(28, 28, 28);
        color: black;
        padding: 20px;
        width: 100%;
        font-family: sans-serif;
        background: white;
        padding: 20px;
      }

      .done {
        background: lightblue;
        border: 1px solid rgb(44, 87, 204);
        padding: 10px;
        border-radius: 5px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="top">
      <h2>USER: {{user.name}}</h2>
      <h3>SITE: {{site.client_site}}</h3>
    </div>

    <div class="editForm">
      <h4>Edit Site Address?</h4>
      <form action="/site/edit_site/{{site._id}}" method="POST">
        {{ edit.hidden_tag() }} {{ edit.client_site.label }} {{
        edit.client_site() }} {{ edit.submit }}
      </form>
    </div>

    <div class="configureScript">
      <h3>What would you like to target?</h3>
      <div class="configOptions">
        <form action="/site/set_elements/{{site._id}}" method="POST">
          <div>
            {{ form.hidden_tag() }} {{ form.elements.label }} {{
            form.elements(rows=3, multiple=True) }}
          </div>
          <button type="submit" class="btn">Submit</button>
        </form>
      </div>
    </div>

    <!-- if site.elements length > 0: -->
    {% if site.elements|length > 0 %}
    <div class="thingYouAreTargeting">
      <h3>Your Targeted Elements:</h3>
      <div class="targetedElements">
        {% for element in site.elements %}
        <div class="targetedElement">
          <p>{{element}}</p>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="script">
      <h3>Script:</h3>
      <div class="scriptCode">
        <div class="clickToCopy">
          <button class="btn" onclick="makeScript()">Copy to Clipboard</button>
        </div>
        <div class="generateScript">
          <a id="siteId" class="btn" href="/site/generate_script/{{site._id}}"
            >Go To Script</a
          >
        </div>
      </div>
    </div>
    {% if events %}
    <div class="events">
      <h3>Events:</h3>
      <div class="eventList">
        {% for event in events %}
        <div class="event">
          {% if event.summary %}
          <p>
            <!-- Summarize: <a href="/event_summary/{{event._id}}">{{event._id}}</a> -->
            Summarized: <br />
            {{event.summary.output_text }}
          </p>
          {% endif %}
          <button id="{{event._id}}" class="btn">
            Summarize: {{event._id}}
          </button>
          <div class="summary"></div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="spinnerWrap">
      <div class="spinner"></div>
    </div>
    {% endif %}
    <script type="text/javascript">
      function makeScript() {
        let baseUrl = window.location.origin;
        let siteId = document.querySelector("#siteId");
        let href = siteId.getAttribute("href");
        let genScript = "<\script src='" + baseUrl + href + "'><\/script>";

        console.log(genScript);

        navigator.clipboard.writeText(genScript);
      }

      let eventButtons = document.querySelectorAll(".event button");
      let summaries = document.querySelectorAll(".summary");
      let spinner = document.querySelector(".spinnerWrap");

      eventButtons.forEach((button, index) => {
        button.addEventListener("click", () => {
          let eventId = button.getAttribute("id");
          let summary = summaries[index];
          let url = "/event_summary/" + eventId;
          button.disabled = true;
          button.classList.add("disabled");
          // Show the spinner while waiting for data
          spinner.style.display = "flex";
          spinner.style.justifyContent = "center";
          spinner.style.alignItems = "center";

          fetch(url, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              summary.innerHTML = `<p>${data.summary.output_text}</p>
              <a href="/save_summary/${eventId}"> Save? </a>`;
              summary.classList.add("done");
              // Hide the spinner when data is received
              spinner.style.display = "none";
            })
            .catch((error) => {
              console.error(error);

              // Hide the spinner if an error occurs
              spinner.style.display = "none";
            });
        });
      });
    </script>
  </body>
</html>
